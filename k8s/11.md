# Kubernetes Secrets and Hashicorp Vault

## Task 1

### Create a secret using `kubectl`

```commandLine
kubectl create secret generic c00l-secret --from-literal=username=c00luser --from-literal=password='c00lpassword'
secret/c00l-secret created
```

### Verify and decode secret

* Verification

```commandLine
kubectl get secrets
NAME                                          TYPE                 DATA   AGE
c00l-secret                                   Opaque               2      3m33s
sh.helm.release.v1.app-python-1712324382.v1   helm.sh/release.v1   1      4d20h
sh.helm.release.v1.helm-hooks.v1              helm.sh/release.v1   1      4d19h
```

```commandLine
kubectl describe secret c00l-secret
Name:         c00l-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  12 bytes
username:  8 bytes
```

* Decoding

```commandLine
kubectl get secret c00l-secret -o jsonpath='{.data}'
{"password":"YzAwbHBhc3N3b3Jk","username":"YzAwbHVzZXI="}
```

```commandLine
echo 'YzAwbHBhc3N3b3Jk' | base64 --decode
c00lpassword
```

```commandLine
echo 'YzAwbHVzZXI=' | base64 --decode
c00luser
```

### Manage secrets with helm

* Generate key pair using `gpg --gen-key`

```commandLine
gpg --gen-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Note: Use "gpg --full-generate-key" for a full featured key generation dialog.

GnuPG needs to construct a user ID to identify your key.

Real name: Insaf
Email address: yuszx02@gmail.com
You selected this USER-ID:
    "Insaf <yuszx02@gmail.com>"

Change (N)ame, (E)mail, or (O)kay/(Q)uit? O
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key 38249653BA35DC34 marked as ultimately trusted
gpg: directory '/home/yuszx/.gnupg/openpgp-revocs.d' created
gpg: revocation certificate stored as '/home/yuszx/.gnupg/openpgp-revocs.d/2F082D0CC3666224A8CD3AB238249653BA35DC34.rev'
public and secret key created and signed.

pub   rsa3072 2024-04-10 [SC] [expires: 2026-04-10]
      2F082D0CC3666224A8CD3AB238249653BA35DC34
uid                      Insaf <yuszx02@gmail.com>
sub   rsa3072 2024-04-10 [E] [expires: 2026-04-10]
```

* Created `secrets.yaml` using `sops -p <key> secrets.yaml` with the following content

```commandLine
password: ENC[AES256_GCM,data:vi2/TcOBV2Iohh6o,iv:zWgHRIwSUoUhxqeYQ6+SoRnzVUxVZelKLohL2776tXg=,tag:szT0rxMa4FWE5AXpPEj/SA==,type:str]
sops:
    kms: []
    gcp_kms: []
    lastmodified: '2024-04-10T12:54:54Z'
    mac: ENC[AES256_GCM,data:Fqs8/p1vr5VO2lVJG0xu0O7v3vRkLrx62Qu4bg3tR1Xmw3X4wzBY5FOWqYt2VVVqStbR0157Y5C+apEsCAkXEAW3OQEhSg8NSP53JxNcTDq35364VB7npo/0yON7SbiaOy80XmTA6SiRrXNq3w9xcIyzc6z/u9w99QzxLQPm/Kk=,iv:Kk+Hvymxg4X6mG1nCgtfVQOpM1tTz9fItLqqaBHWJ0Q=,tag:s9Cpm7vcw4Q1FKV7hgOotA==,type:str]
    pgp:
    -   created_at: '2024-04-10T12:52:36Z'
        enc: |
            -----BEGIN PGP MESSAGE-----

            hQGMA2owObLqZhd+AQv+KYBkdOmXICzeFU0f01CEFDAdiimpp8DMAqLfll5DjimA
            G3GCs+HhKa0SsyHB8I76Ko0VN/9C1cy+ubkoG4heSoXXYc6tay64LaV24MNVIe57
            b+2CT88y8YkZFbVc16zvAHzsKRTR8F8jUdscvTZj0xGSzZraEhma5IeZ7g9z/xNV
            ZbOX4ckdPIM/3Ajclux/pVkchyTXYDrgU2RVC4Vhp/agOpMAaoPHKmj7Dll7n3fl
            ZHHjFqwNRvsAj3em+QQWYgehq78tG4JnAhFkk4zZKmjElf8rVwSKV7o0jwLs7A/f
            HWmTrWX1VsAfzFEdY23hLIaxDCMspz+n12OmPJG7Ueyn1x9qCrW/2/lx75H/I9qB
            +y4R3it3MRK8kj2P/7/V5fBv7tK6Um9gylNrSfMg4OwY0kMELAnXJutsXc6EZlRp
            D/IhdtAA7nlGr7Mkox94qWuL1ax3PBYiy/QiEKZFkkMutwnqryQkDkT6sGufxEie
            qdHqeT4ehl6TWVM9hRjz0lwBwxw2RxoNOtiJAdLEw1w5yYO2XTnF1daSrqzkdq33
            Uj884fMaEweFM4p6yu69l8NZ+PZvVY+dO7lOqi3l92gZI/7WcxfFuJUD7qYsZPZx
            OAR6NPUQGQxNvENd+A==
            =SK3E
            -----END PGP MESSAGE-----
        fp: 2F082D0CC3666224A8CD3AB238249653BA35DC34
    unencrypted_suffix: _unencrypted
    version: 3.0.3
```

```commandLine
helm secrets view secrets.yaml
password: c00lpassword
```

* Create `secrets.yaml` in `templates` folder with the following content

```YAML
apiVersion: v1
kind: Secret
metadata:
  name: credentials
type: Opaque
data:
  password: {{ .Values.password | toString | b64enc }}
```

* Add `env` field to `deployment.yaml`

```YAML
env:
- name: MY_PASSWORD
  valueFrom:
    secretKeyRef:
        name: credentials
        key: password
```

* Update helm deployment

```commandLine
helm secrets install new-app-python ./app-python -n default -f ./secrets.yaml
NAME: new-app-python
LAST DEPLOYED: Wed Apr 10 17:23:27 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w new-app-python'
  export SERVICE_IP=$(kubectl get svc --namespace default new-app-python --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:5000
removed './secrets.yaml.dec'
```

* Output of `kubectl get po`

```commandLine
kubectl get po
NAME                                     READY   STATUS    RESTARTS        AGE
new-app-python-7c5dd6dcf9-2rkjn          1/1     Running   0               3m39s
```

* Verifying secret inside the pod

```commandLine
kubectl exec new-app-python-7c5dd6dcf9-2rkjn -- printenv | grep MY_PASS
MY_PASSWORD=c00lpassword
```

## Task 2

```commandLine
yuszx@yuszx-VirtualBox:~/devops/k8s$ kubectl get pods
NAME                                     READY   STATUS    RESTARTS        AGE
app-python-vault-54fbd9d4b-kczq2         2/2     Running   0               43s
vault-0                                  1/1     Running   0               43m
vault-agent-injector-dbfc5cd77-fhq68     1/1     Running   1 (3m33s ago)   44m
yuszx@yuszx-VirtualBox:~/devops/k8s$ kubectl exec -it app-python-vault-54fbd9d4b-kczq2 -- /bin/sh
Defaulted container "app-python" out of: app-python, vault-agent, vault-agent-init (init)
/app_python $ cat /vault/secrets/database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard/app_python $ 
/app_python $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  23.9G     19.6G      3.1G  86% /
tmpfs                    64.0M         0     64.0M   0% /dev
/dev/sda3                23.9G     19.6G      3.1G  86% /dev/termination-log
tmpfs                     7.7G      4.0K      7.7G   0% /vault/secrets
/dev/sda3                23.9G     19.6G      3.1G  86% /etc/resolv.conf
/dev/sda3                23.9G     19.6G      3.1G  86% /etc/hostname
/dev/sda3                23.9G     19.6G      3.1G  86% /etc/hosts
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                     7.7G     12.0K      7.7G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                     3.9G         0      3.9G   0% /proc/asound
tmpfs                     3.9G         0      3.9G   0% /proc/acpi
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     3.9G         0      3.9G   0% /proc/scsi
tmpfs                     3.9G         0      3.9G   0% /sys/firmware
```
